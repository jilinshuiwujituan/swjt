<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时定位地图系统</title>
    <style>
        #mapContainer {
            width: 100%;
            height: 85vh;
        }
        .control-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: #fff;
            padding: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #1890ff;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 25px;
            margin: 5px;
            width: 95%;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div id="mapContainer"></div>
    
    <div class="control-bar">
        <button class="btn" onclick="openLocationForm()">
            📍 打开表单添加标记
        </button>
    </div>

    <script src="https://webapi.amap.com/maps?v=2.0&key=81af62ba5eb2df43dce2f2e564caa0ae"></script>
    <script>
        let map;
        let userMarker;  // 用户当前位置标记
        let currentPosition = null;

        // 初始化地图和定位
        function initMap() {
            map = new AMap.Map('mapContainer', {
                zoom: 16,
                resizeEnable: true
            });

            // 初始化定位组件
            AMap.plugin('AMap.Geolocation', () => {
                const geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true,  // 高精度定位
                    timeout: 10000,            // 超时时间
                    showMarker: true,          // 显示定位标记
                    showCircle: true,          // 显示精度圆圈
                    panToLocation: true        // 定位成功自动跳转
                });

                // 实时监听位置变化（移动端适用）
                geolocation.watchPosition((status, result) => {
                    if (status === 'complete') {
                        handlePositionSuccess(result);
                    } else {
                        handlePositionError(result);
                    }
                });

                map.addControl(geolocation);
            });
        }

        // 处理定位成功
        function handlePositionSuccess(result) {
            currentPosition = {
                lng: result.position.getLng(),
                lat: result.position.getLat()
            };
            
            // 更新用户位置标记
            if (!userMarker) {
                userMarker = new AMap.Marker({
                    position: [currentPosition.lng, currentPosition.lat],
                    content: '<div style="background:blue;border-radius:50%;width:20px;height:20px;"></div>',
                    offset: new AMap.Pixel(-10, -10)
                });
                map.add(userMarker);
            } else {
                userMarker.setPosition([currentPosition.lng, currentPosition.lat]);
            }
        }

        // 处理定位失败
        function handlePositionError(error) {
            const errorMessages = {
                1: '位置服务被拒绝',
                2: '暂时无法获取位置信息',
                3: '获取位置信息超时'
            };
            alert(errorMessages[error.error_code] || '定位失败');
        }

        // 打开草料表单（示例URL）
        function openLocationForm() {
            if (!currentPosition) {
                alert('请等待定位完成');
                return;
            }
            
            // 草料表单URL模板（需替换实际参数）
            const formUrl = `https://h5.clewm.net/?url=qr61.cn%2Fo1hiwH%2FqJn4Dq3{currentPosition.lng}&lat=${currentPosition.lat}`;
            window.open(formUrl, '_blank');
        }

        // 初始化
        window.onload = initMap;
    </script>
</body>
</html>